{% load reviews-extras %}
{% block content %}
    <section class="feed-container">

        <!-- Boucle unique sur posts -->
        {% for obj in posts %}
            <article class="feed-container__item">
                {% if obj.title %}
                    <!-- C'est un Ticket -->
                    {% with obj as ticket %}
                    <section class="post-item">
                        <header class="post-item__header">
                            <p class="post-item__author">
                                {% get_poster_display ticket.user %} demandé une critique
                            </p>
                            <time class="post-item__time">{{ ticket.time_created }}</time>
                        </header>
                        <h2 class="post-item__headline">{{ ticket.title }}</h2>
                        <p class="post-item__description">{{ ticket.description }}</p>

                        {% if ticket.photo %}
                            <img class="ticket-item__image" src="{{ ticket.photo.image.url }}" alt="Photo du billet">
                        {% endif %}

                        {% if show_buttons and ticket.user == request.user %}
                            <div class="post-item__buttons--edit">
                                <a href="{% url 'edit_ticket' ticket.id %}" class="btn btn-primary">Modifier</a>
                                <form method="post" action="{% url 'edit_ticket' ticket.id %}">
                                    {{ delete_form }}
                                    {% csrf_token %}
                                    <button type="submit" name="delete_ticket" class="btn btn-secondary">Supprimer</button>
                                </form>
                            </div>
                        {% endif %}

                        {% if not show_buttons and not ticket.review_set.all %}
                            <button type="button" class="btn btn-primary btn-create-review" onclick="window.location.href='{% url 'create-review' ticket.id %}'">Créer une critique</button>
                        {% endif %}
                    </section>
                    {% endwith %}
                {% elif obj.headline %}
                    <!-- C'est une Review -->
                    {% with obj as review %}
                    <section class="post-item">
                        <header class="post-item__header">
                            <p class="post-item__author">{% get_poster_display review.user %} publié une critique</p>
                            <time class="post-item__time">{{ review.time_created }}</time>
                        </header>
                        <h3 class="post-item__headline">{{ review.headline }}</h3>
                        <p class="review-item__rating">
                            <span class="rating__label">Note :</span>
                            <span class="rating__stars">{{ review.star_rating }}</span>
                        </p>
                        <p class="post-item__description">{{ review.body }}</p>

                        <!-- Résumé du ticket lié -->
                        <div class="ticket-summary">
                            <div class="post-item">
                                <header class="post-item__header">
                                    <p class="post-item__author">{{ review.ticket.user }} a demandé une critique</p>
                                    <time class="post-item__time">{{ review.ticket.time_created }}</time>
                                </header>
                                <h2 class="post-item__headline">{{ review.ticket.title }}</h2>
                                <p class="post-item__description">{{ review.ticket.description }}</p>
                            </div>

                            {% if review.ticket.photo %}
                                <div class="ticket-item__image-container--thumbnail">
                                    <img class="ticket-item__image image-thumbnail" src="{{ review.ticket.photo.image.url }}" alt="Photo du billet">
                                </div>
                            {% endif %}
                        </div>
                    </section>
                    {% endwith %}
                {% else %}
                    <!-- Type inconnu -->
                    <p>Type de contenu inconnu</p>
                {% endif %}
            </article>
        {% endfor %}

    </section>
{% endblock content %}